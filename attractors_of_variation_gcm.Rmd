We need three sets.

A training set for stable CVC verbs. A training set for stable CC verbs. The test set from the data. The sets consist of the 3pl-decl forms, in converted orthography.

```{r }
setwd('~/Work/Bristol/dohanyozik/dohanyozik_gcm_nak/')
library(stringr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(stringi)
library(stringdist)
load('magyar.Rfnc')
```

# Setting up training

We query 3pl-decl verbs on szotar.mokk.bme.hu/szoszablya/searchq.php. We filter the data. We create two training sets, for CVC and CC stable verbs.

```{r }
input <- read.delim('nak_hits.csv', sep=';')
# I remove odd suppletive forms
weirdos <- c('kell','van','lehet','megy','tesz','visz','fűt','vesz','eszik','iszik','hisz','morog','címez')
# I remove forms with -ít
# input %>% filter(freq > 9) %>% nrow 6423
input <- input %>% filter(freq > 9, !lemma %in% weirdos, !str_detect(lemma, 'ít$'))

# I remove CVC/CC verbs from our original unfiltered list of 111
original_list <- read.delim('~/Work/Bristol/dohanyozik/initial_query_list.txt', header=T) %>% rename(word = x)

input <- input %>% filter(!lemma %in% original_list$word) # 54 overlaps

# I make it into a transcription
input <- input %>% mutate(lemma2 = magyar(lemma), word2 = magyar(word))

# now it's easy to find stable CVC and CC verbs. if it has a linking vowel between stem and -nAk, it's CC

# vowel <- "[aeiouAEIOUyxXY]"
# consonant <- "[^aeiouAEIOUyxXY]"

input <- input %>% mutate(stem_type = ifelse(str_detect(word2, '[ae]n[ae]k'), 'cc', 'cvc'))

# input %>% filter(stem_type == 'cc') %>% select(word,word2,lemma) %>% nrow
# input %>% filter(stem_type == 'cvc') %>% select(word,word2,lemma) %>% nrow

# some compounds won't really work, like befut -> always befutenek, never befutnek! probably because stem super short. exclude!

# bad_lemmata <- input %>% filter(stem_type == 'cc', str_detect(lemma2, '[aeiouAEIOUyxXY][^aeiouAEIOUyxXY]$')) %>% filter(!str_detect(lemma2, 'ik$')) %>% select(lemma2) %>% pull

# overkill
bad_lemmata <- c('boTAt', 'fYt', 'elboTAt', 'megboTAt', 'mYt', 'kiboTAt', 'hYt', 'befYt', 'megmYt', 'vet')

input <- input %>% filter(!lemma2 %in% bad_lemmata)

input %>% filter(stem_type == 'cc') %>% select(word,word2,lemma) %>% nrow
input %>% filter(stem_type == 'cvc') %>% select(word,word2,lemma) %>% nrow

training_cvc <- input %>% filter(stem_type == 'cvc') %>% select(lemma2) %>% rename(word = lemma2)
training_cc <- input %>% filter(stem_type == 'cc') %>% select(lemma2) %>% rename(word = lemma2)
```


# Setting up test set. There will be two: one based on cvc ("aramolnak") and one based on cc ("aramlanak"). 

```{r }
my_words <- read.csv('~/Work/Bristol/dohanyozik/formatted_filtered_hits_pairs_current.txt')

cvc_test <- my_words %>% filter(exponent == '[nAk]') %>% select(v_form) %>% unique %>% rename(word = v_form) %>% mutate(word = magyar(word)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X'))

cc_test <- my_words %>% filter(exponent == '[nAk]') %>% select(nv_form) %>% unique %>% rename(word = nv_form) %>% mutate(word = magyar(word)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X')) # whoops
```

# Running Lisa Dawdy-Hesterberg's GCM

The script is a perl script from Lisa Hesterberg. It needs various files to be in the right place. Basically, this R script writes things in place, runs the perl script, and gathers data.

 some comments on Life:
 - I downloaded the similarity calculator from Albright's site (2017). It did weird things if I had accents on the vowels so I removed that.
 - Lisa Hesterberg's script wants both the stb and the cls file generated by the similarity calculator. for no good reason it expects the stb file to start with class1 and class2 rather than seg1 and seg2. i fixed that in notepad and then it worked.

 some comments on what I want to do:
 - I want to run the GCM with the target verbs for our project as the test verbs and other verbs that have both the conditional and the thirdsg in the corpus as training verbs
 - In one run, I use the thirdsg (the base forms) as training and test data
 - In the other run, I use the conditional (the derived forms) as training and test data
 - I compare the two sets of weights

```{r eval=F}
wrapGCMsetupH <- function(name,irregular,regular,test){

############################################################################################################
# you set up 
# training sets Category A and Category B 
# test set
# as character vectors with names (such as categorya and categoryb and test). The function does the rest.
############################################################################################################

# fun fact: for some bizarre reason that I can't even begin to fathom it only works if you call the files 'irregular' and 'regular'

# oh well most category decision tasks are irregular and regular anyway.

# dirs needed
dir.create(name)
dir.create(paste(name,'/islandfiles', sep=''))
dir.create(paste(name,'/islandfiles/output', sep=''))
  
# helpers needed
system(paste('cp -R helpers/featurefiles', name))
system(paste('cp -R helpers/lisa_gcm_mod_hun.pl', name))

# files needed
# training A
irregular <- irregular %>% mutate(class = 'irregular')
# training B
regular <- regular %>% mutate(class = 'regular')
# test
test <- test %>% select(word) %>% mutate(class = 'irregular') # this is dummy coding. we don't actually know what the real category is.
# - answerkeys.txt is all items; it is also specified which stem belongs to which category
answerkeys <- rbind(irregular,regular,test)
# - allforms.txt is all the training items, just the stem, one per line
allforms <- rbind(irregular,regular) %>% select(word)
# - outputitems.txt is a list of all the test items, just the stem, one per line
outputitems <- test %>% select(word)
# 

# put things in place
answerkeys %>% write.table(file=paste(name,'/answerkeys.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

# irregular
irregular %>% select(word) %>% write.table(file=paste(name,'/islandfiles/irregular.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

irregular %>% select(word) %>% write.table(file=paste(name,'/islandfiles/output/irregular.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

# regular
regular %>% select(word) %>% write.table(file=paste(name,'/islandfiles/regular.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

regular %>% select(word) %>% write.table(file=paste(name,'/islandfiles/output/regular.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

allforms %>% write.table(file=paste(name,'/islandfiles/output/allforms.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

# /islandfiles/output/outputitems.txt (all test words w/o filenames)

outputitems %>% write.table(file=paste(name,'/islandfiles/output/outputitems.txt', sep=''), row.names=F, col.names=F, sep='\t', quote=FALSE)

# pull in everything and assign weights


}

getGCMresH <- function(name){
thing <- read.csv(paste(name, '/', name, '_out.txt', sep=''), header = F)
names(thing) <- c('disc','judgement','judgement_weight','other_weight')
thing$gcm.regular <- ifelse(thing$judgement == 'regular', thing$judgement_weight, thing$other_weight)
thing <- thing[,c('disc','gcm.regular')]
return(thing)
}

# wrapGCMsetupH("cvcnak",training_cc,training_cvc,cvc_test)
# setwd('cvcnak') # perl script needs dir
# system('perl lisa_gcm_mod_hun.pl 0.3 > cvcnak_out.txt')
# setwd('~/Work/Bristol/dohanyozik/dohanyozik_gcm_nak/')

cvc_gcm <- getGCMresH('cvcnak') %>% rename(word = disc)

cvc_gcm <- merge(cvc_gcm,cvc_test) %>% rename(cvc_weight_nak = gcm.regular) %>% select(word,cvc_weight_nak)

matcher1 <- my_words %>% filter(exponent == '[nAk]') %>% select(v_form,ik) %>% unique %>% mutate(word = magyar(v_form)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X'))

my_words1 <- merge(cvc_gcm,matcher1) %>% select(cvc_weight_nak,ik) %>% merge(my_words)

# wrapGCMsetupH("ccnak",training_cc,training_cvc,cc_test)
# setwd('ccnak') # perl script needs dir
# system('perl lisa_gcm_mod_hun.pl 0.3 > ccnak_out.txt')
# setwd('~/Work/Bristol/dohanyozik/dohanyozik_gcm_nak/')

cc_gcm <- getGCMresH('ccnak') %>% rename(word = disc)

cc_gcm <- merge(cc_gcm,cc_test) %>% rename(cvc_weight_anak = gcm.regular) %>% select(word,cvc_weight_anak)

matcher2 <- my_words %>% filter(exponent == '[nAk]') %>% select(nv_form,ik) %>% unique %>% mutate(word = magyar(nv_form)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X'))


my_words2 <- merge(cc_gcm,matcher2) %>% select(cvc_weight_anak,ik) %>% merge(my_words1)

# write.csv(my_words2, file='formatted_filtered_hits_pairs_current_gcm.txt', row.names = F)
############################################################################


with(my_words2, cor.test(cvc_weight_nak,cvc_weight_anak)) #.5 -> .19
with(my_words2, cor.test(cvc_weight_anak,log_odds)) #.2 -> .19
with(my_words2, cor.test(cvc_weight_nak,log_odds)) #.43 -> .27
```

# Running my simple GCM

...and here is my hand-made GCM.

```{r }
# my_words2 <- read.csv('formatted_filtered_hits_pairs_current_gcm.txt')
my_words2 <- my_words

GCM <- function(test_forms,category_A,category_B,all_forms,var_s,var_p){

vector_sim_cat_A = as.numeric(NULL)
vector_sim_cat_B = as.numeric(NULL)

for (i in 1:length(test_forms)){
  form1 = test_forms[i]  
  
  vector_pairwise_sims_cat_A = as.numeric(NULL)
  
    for (ii in 1:length(category_A)){
      form2 = category_A[ii]
        dist = stringdist(form1,form2, method = 'lv')
          pairwise_sim = exp ( - dist / var_s )^var_p
            vector_pairwise_sims_cat_A[ii] = pairwise_sim
    }
  
  sum_pairwise_sims_cat_A = sum(vector_pairwise_sims_cat_A)
  
  vector_pairwise_sims_cat_B = as.numeric(NULL)
  
    for (ii in 1:length(category_B)){
      form2 = category_B[ii]
        dist = stringdist(form1,form2, method = 'lv')
          pairwise_sim = exp ( - dist / var_s )^var_p
            vector_pairwise_sims_cat_B[ii] = pairwise_sim
    }
  
  sum_pairwise_sims_cat_B = sum(vector_pairwise_sims_cat_B)
  
  vector_pairwise_sims_all_forms = as.numeric(NULL)
  
    for (ii in 1:length(all_forms)){
      form2 = all_forms[ii]
        dist = stringdist(form1,form2, method = 'lv')
          pairwise_sim = exp ( - dist / var_s )^var_p
            vector_pairwise_sims_all_forms[ii] = pairwise_sim
    }
  
  sum_pairwise_sims_all_forms = sum(vector_pairwise_sims_all_forms)
  
  sim_cat_A = sum_pairwise_sims_cat_A / sum_pairwise_sims_all_forms
  sim_cat_B = sum_pairwise_sims_cat_B / sum_pairwise_sims_all_forms
  
  vector_sim_cat_A[i] <- sim_cat_A
  vector_sim_cat_B[i] <- sim_cat_B

}

output_thing <- cbind(test_forms,vector_sim_cat_A,vector_sim_cat_B) %>% data.frame %>% rename(disc = test_forms, weight_A = vector_sim_cat_A, weight_B = vector_sim_cat_B) 

return(output_thing)
}

# get vectors

cc_test <- cc_test %>% pull
cvc_test <- cvc_test %>% pull
training_cc <- training_cc %>% pull
training_cvc <- training_cvc %>% pull
all_forms <- c(training_cc,training_cvc)

# cc

cc_gcm <- GCM(cc_test,training_cvc,training_cc,all_forms,0.3,1)

# cvc 

cvc_gcm <- GCM(cvc_test,training_cvc,training_cc,all_forms,0.3,1)

matcher1 <- my_words %>% filter(exponent == '[nAk]') %>% select(v_form,ik) %>% unique %>% mutate(word = magyar(v_form)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X'))

cvc_gcm <- cvc_gcm %>% select(disc, weight_A) %>% rename(word = disc, cvc_weight_nak_nof = weight_A)

matcher1 <- merge(matcher1,cvc_gcm) %>% select(cvc_weight_nak_nof,ik)

matcher2 <- my_words %>% filter(exponent == '[nAk]') %>% select(nv_form,ik) %>% unique %>% mutate(word = magyar(nv_form)) %>% mutate(word = str_replace_all(word, 'ű', 'Y')) %>% mutate(word = str_replace_all(word, 'ő', 'X'))

cc_gcm <- cc_gcm %>% select(disc, weight_A) %>% rename(word = disc, cvc_weight_anak_nof = weight_A)

matcher2 <- merge(matcher2,cc_gcm) %>% select(cvc_weight_anak_nof,ik)

my_words3 <-merge(my_words2,matcher1) %>% mutate(cvc_weight_nak_nof = as.numeric(as.character(cvc_weight_nak_nof)))

my_words3 <-merge(my_words3,matcher2) %>% mutate(cvc_weight_anak_nof = as.numeric(as.character(cvc_weight_anak_nof)))

```


Comparing the two.

```{r }


with(my_words3, cor.test(cvc_weight_nak,cvc_weight_nak_nof)) #.799
with(my_words3, cor.test(cvc_weight_nak,log_odds)) #.27
with(my_words3, cor.test(cvc_weight_nak_nof,log_odds)) #.32 # ouch

with(my_words3, cor.test(cvc_weight_anak_nof,log_odds)) # .119
with(my_words3, cor.test(cvc_weight_anak_nof,cvc_weight_nak_nof)) # .48

my_words3$cvc_weight_anak <- NULL
my_words3$cvc_weight_nak <- NULL

# write.csv(my_words3, file='formatted_filtered_hits_pairs_current_gcm_nof.txt', row.names = F)

```
